<!DOCTYPE html>
<html>
    <head>
        <title>ms-wheel</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" /> 
        <script src="../avalon.js"></script>
        <script>
            avalon.define("test", function(vm) {
                vm.xxx = function(e) {
                    console.log(e.deltaY+ e.type)
                    console.log(this)
                }
            })
        </script>
    </head>

    <body ms-controller="test">
<!--        <div ms-on-mousewheel="fn1"  style="background: red;width:200px;height: 200px;padding:20px;float:left">
           
        </div>-->
         <div ms-on-wheel="xxx"  style="background: blue;width:200px;height: 200px;padding:20px;float:left">
           wheel
        </div>

<pre>
                
  //针对IE6-8,及旧的W3C修正wheel https://developer.mozilla.org/en-US/docs/Web/Reference/Events/wheel
    //  if (!window.WheelEvent) {

    function getLineHeight(elem) {
        var parent = elem.offsetParent
        if (!parent) {
            parent = document.body
        }
        return avalon.css(parent, "fontSize", true)
    }
    function nullLowestDelta() {
        lowestDelta = null
    }
    var nullLowestDeltaTimeout, lowestDelta
    function shouldAdjustOldDeltas(orgEvent, absDelta) {
        // If this is an older event and the delta is divisable by 120,
        // then we are assuming that the browser is treating this as an
        // older mouse wheel event and that we should divide the deltas
        // by 40 to try and get a more usable deltaFactor.
        // Side note, this actually impacts the reported scroll distance
        // in older browsers and can cause scrolling to be slower than native.
        // Turn this off by setting $.event.special.mousewheel.settings.adjustOldDeltas to false.
        return orgEvent.type === 'mousewheel' && absDelta % 120 === 0;
    }

    eventHooks.wheel = {
        type: window.WheelEvent ? "wheel" : (document.onmousewheel !== void 0 ? "mousewheel" : "DOMMouseScroll"),
        deel: function(elem, fn) {
            elem["mousewheel-line-height"] = getLineHeight(elem)
            elem["mousewheel-page-height"] = avalon(elem).heigth()
            return function(event) {
                delete event.type
                event.type = "wheel"
                if (event.type !== "wheel" && Object.defineProperty) {
                    Object.defineProperty(event, "type", {
                        value: "wheel"
                    })
                }


                return fn.call(elem, event)
            }
        }
    }
                                                                          
   // console.log(eventHooks.wheel)
    //  }


    var orgEvent = event.originalEvent || event
                var delta = 0
                var deltaX = 0
                var deltaY = 0
                var absDelta = 0
                var offsetX = 0
                var offsetY = 0

                if ('detail'      in orgEvent) {
                    deltaY = orgEvent.detail * -1;
                }
                if ('wheelDelta'  in orgEvent) {
                    deltaY = orgEvent.wheelDelta;
                }
                if ('wheelDeltaY' in orgEvent) {
                    deltaY = orgEvent.wheelDeltaY;
                }
                if ('wheelDeltaX' in orgEvent) {
                    deltaX = orgEvent.wheelDeltaX * -1
                }
                // Firefox < 17 horizontal scrolling related to DOMMouseScroll event
                if ('axis' in orgEvent && orgEvent.axis === orgEvent.HORIZONTAL_AXIS) {
                    deltaX = deltaY * -1
                    deltaY = 0
                }
                // Set delta to be deltaY or deltaX if deltaY is 0 for backwards compatabilitiy
                delta = deltaY === 0 ? deltaX : deltaY

                // New school wheel delta (wheel event)
                if ('deltaY' in orgEvent) {
                    deltaY = orgEvent.deltaY * -1
                    delta = deltaY
                }
                if ('deltaX' in orgEvent) {
                    deltaX = orgEvent.deltaX
                    if (deltaY === 0) {
                        delta = deltaX * -1
                    }
                }

                // No change actually happened, no reason to go any further
                if (deltaY === 0 && deltaX === 0) {
                    return
                }

                // Need to convert lines and pages to pixels if we aren't already in pixels
                // There are three delta modes:
                //   * deltaMode 0 is by pixels, nothing to do
                //   * deltaMode 1 is by lines
                //   * deltaMode 2 is by pages
                if (orgEvent.deltaMode === 1) {
                    var lineHeight = elem["mousewheel-line-height"]
                    delta *= lineHeight
                    deltaY *= lineHeight
                    deltaX *= lineHeight
                } else if (orgEvent.deltaMode === 2) {
                    var pageHeight = elem ["mousewheel-page-height"]
                    delta *= pageHeight
                    deltaY *= pageHeight
                    deltaX *= pageHeight
                }

                // Store lowest absolute delta to normalize the delta values
                absDelta = Math.max(Math.abs(deltaY), Math.abs(deltaX))

                if (!lowestDelta || absDelta < lowestDelta) {
                    lowestDelta = absDelta

                    // Adjust older deltas if necessary
                    if (shouldAdjustOldDeltas(orgEvent, absDelta)) {
                        lowestDelta /= 40
                    }
                }

                // Adjust older deltas if necessary
                if (shouldAdjustOldDeltas(orgEvent, absDelta)) {
                    // Divide all the things by 40!
                    delta /= 40
                    deltaX /= 40
                    deltaY /= 40
                }

                // Get a whole, normalized value for the deltas
                delta = Math[ delta >= 1 ? 'floor' : 'ceil' ](delta / lowestDelta)
                deltaX = Math[ deltaX >= 1 ? 'floor' : 'ceil' ](deltaX / lowestDelta)
                deltaY = Math[ deltaY >= 1 ? 'floor' : 'ceil' ](deltaY / lowestDelta)

                // Normalise offsetX and offsetY properties
                if (this.getBoundingClientRect) {
                    var boundingRect = this.getBoundingClientRect()
                    offsetX = event.clientX - boundingRect.left
                    offsetY = event.clientY - boundingRect.top
                }

                // Add information to the event object
                event.deltaX = deltaX;
                event.deltaY = deltaY;
                event.deltaFactor = lowestDelta;
                event.offsetX = offsetX;
                event.offsetY = offsetY;
                // Go ahead and set deltaMode to 0 since we converted to pixels
                // Although this is a little odd since we overwrite the deltaX/Y
                // properties with normalized deltas.
                event.deltaMode = 0

                if (nullLowestDeltaTimeout) {
                    clearTimeout(nullLowestDeltaTimeout);
                }
                nullLowestDeltaTimeout = setTimeout(nullLowestDelta, 200)
</pre>
    </body>
</html>