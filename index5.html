<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="avalon.js"></script>
    </head>
    <body>
        <script>
            function expect(a) {
                return {
                    to: {
                        be: function (b) {
                            console.log(a, b, a === b)
                        }
                    }
                }
            }
            function fireClick(el) {
                if (el.click) {
                    el.click()
                } else {
                    //https://developer.mozilla.org/samples/domref/dispatchEvent.html
                    var evt = document.createEvent("MouseEvents")
                    evt.initMouseEvent("click", true, true, window,
                            0, 0, 0, 0, 0, false, false, false, false, 0, null);
                    !el.dispatchEvent(evt);
                }
            }
            function heredoc(fn) {
                return fn.toString().replace(/^[^\/]+\/\*!?\s?/, '').replace(/\*\/[^\/]+$/, '')
            }
            var vm = avalon.define({
                $id: "test",
              
                list: ["1"],
              
                click: function () {
                    vm.list.push("3")
                },
                clear: function () {
                    vm.list = []
                },
                serialize: function () {
                    return vm.list.$model + ""
                }
            })
            var body = document.body
            var div = document.createElement("div")
            div.innerHTML = heredoc(function () {
                /*
                 <a href="#"  ms-on-click="click">add</a> <br>
                 <a href="#"  ms-on-click="serialize">serialize</a> <br>
                 <a href="#"  ms-on-click="clear">clear</a>
                 <p >
                     <input type="text" ms-repeat-el="list" ms-attr-hehe="$index" ms-duplex="el">
                 </p>
                 */
            })
            body.appendChild(div)
            avalon.scan(div, vm)
            setTimeout(function () {
                var input = div.getElementsByTagName("input")[0]
                expect(vm.serialize()).to.be("1")
                input.value = "2"
            }, 100)
            setTimeout(function () {
                expect(vm.serialize()).to.be("2")
            }, 300)
            setTimeout(function () {
                var as = div.getElementsByTagName("a")
                fireClick(as[2]) //请空
                setTimeout(function () {
                    var input = div.getElementsByTagName("input")
                    expect(input.length).to.be(0)
                    fireClick(as[0]) //添加3
                    fireClick(as[0]) //添加3
                    fireClick(as[0]) //添加3
                    //    fireClick(as[0]) //添加3
                }, 300)
                setTimeout(function () {
                    var input = div.getElementsByTagName("input")
                    input[0].value = 8 //请空
                    input[2].value = 7 //请空
                }, 600)
                setTimeout(function () {
                    expect(vm.serialize()).to.be("8,3,7")
                 //   clearTest("repeat-has-duplex", div, done)
                }, 900)
            }, 300)
        </script>
        <pre>
<!--             <a href="#"  ms-on-click="click">add</a> <br>
                 <a href="#"  ms-on-click="serialize">serialize</a> <br>
                 <a href="#"  ms-on-click="clear">clear</a>-->
                if(typeof accessor.set === "function"){
                    var fnArr = [], valArr = []
                    for (var i in accessor.dependencies) {
                        if (accessor.dependencies.hasOwnProperty(i)) {
                            var fn = accessor.dependencies[i]
                            fnArr.push(fn) //收集依赖访问器
                            valArr.push(fn._value)//收集旧值
                            fn.notify = noop //阻止它们触发$watch回调
                         //   swapFn(this.$events[fn._name], accessor.digest, accessor.checkChange)
                        }
                    }
                    accessor.set.call(this, value) //更新依赖访问器的值
                    var isChange = false
                    for (i = 0; fn = fnArr[i]; i++) {
                        if(fn._value !== valArr[i] ){
                            isChange = true //判定依赖项有没有发生变化
                            break
                        }
                    //   swapFn(this.$events[fn._name], accessor.checkChange, accessor.digest)
                    }
                  //  accessor.notify = noop
                    if (isChange) { 
                         value = accessor.get.call(this)
                        if (oldValue !== value ) {//判定计算属性有没有发生
                            accessor.updateValue(this, value)
                            isChange = true
                         //   accessor.notify(this, value, oldValue) //触发$watch回调
                        }else{
                            isChange = false
                        }
                       // accessor.call(this)
                    }
                    for (i = 0; fn = fnArr[i]; i++) {
                        fn.notify = globalNotify
                        if(fn._value !== valArr[i] ){
                           fn.notify(this, fn._value, valArr[i] )
                        }
                    }
                  //    accessor.notify = globalNotify
                    if(isChange){
                        accessor.notify(this, value, oldValue )
                    }
                    
        </pre>
    </body>
</html>
