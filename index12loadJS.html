<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script>
            //http://hikejun.com/blog/2011/05/15/js%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E5%A4%B1%E8%B4%A5%E5%A4%84%E7%90%86/
            var loadJS = (function() {
                var DOC = document,
                        HEAD = document.getElementsByTagName('head')[0];
                // 往head注入一个script
                var injectScript = function(src, beforeInject) {
                    var script = document.createElement('script');
                    beforeInject.call(script);
                    script.src = src;
                    script.async = true;
                    HEAD.insertBefore(script, HEAD.firstChild);
                    return script;
                };
                // 销毁script标签
                var destoryScript = function(script) {
                    script.onerror = script.onreadystatechange = script.onload = null;
                    if (script.parentNode) {
                        script.parentNode.removeChild(script)
                    }
                    script = null;
                }
                return function(src, success, failure) {
                    if (DOC.dispatchEvent) {
                        // 对于w3c标准浏览器，采用onerror和onload判断脚本加载情况
                        injectScript(src, function() {
                            var script = this;
                            script.onload = function() {
                                //  destoryScript(script);
                                success()
                            };
                            script.onerror = function() {
                                destoryScript(script);
                                failure()
                            };
                        });
                    } else {
                    //在旧式IE下，我们一个URL可能需要两个SCRIPT标签，第一个用于检测死链，通过将它的language设置为
                    //vbscript，然后检测其readyState的状态
                    //第2个用于明确其不是死链的情况下进行加载
                        injectScript(src, function() {
                            var vbtest = this, flag = 0;
                            vbtest.language = 'vbscript';
                            var errorHandler = function() {
                                // 错误时，判断脚本是否正在解释，是则标志加载成功
                                if (vbtest.readyState == 'interactive') {
                                    flag = 1;
                                }
                                //http://stackoverflow.com/questions/8087240/if-i-override-window-onerror-in-javascript-should-i-return-true-or-false
                                return true;
                            };

                            window.attachEvent('onerror', errorHandler);
                            vbtest.onreadystatechange = function(_, isAbort) {
                                if (/loaded|complete/.test(this.readyState)) {
                                    // 标志位，当加载成功，置1；
                                    if (flag == 1){
                                        injectScript(src, function() {
                                            var script = this;
                                            script.onreadystatechange = function() {
                                                if (/loaded|complete/.test(this.readyState)) {
                                                    destoryScript(script);
                                                    success()
                                                }
                                            };
                                        });
                                    }else {
                                        failure()
                                    }
                                    // 为window绑定一个错误，当js被误加载成vb的时候，会发生错误，来判断是否加载成功
                                    window.detachEvent('onerror', errorHandler);
                                    destoryScript(vbtest);
                                }
                            };
                        })
                    }
                }
            })()

            loadJS("avalon.js", function() {
                console.log("ok")
                //alert(window.avalon)
                avalon.define("xxx", function(vm){
                    vm.name = "司徒正美"
                })
                avalon.scan()
                
            }, function() {
                console.log("error")
            })
            console.log("111111111")
        </script>
    </head>
    <body ms-controller="xxx">
        <div>TODO write content</div>
        <p>{{name}}</p>
    </body>
</html>
