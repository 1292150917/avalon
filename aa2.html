<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script src="avalon.js"></script>
        <style>
            .wrapper {
                overflow-y: scroll;
                border: 1px solid green;
                height: 210px;
            }
            table{
                border:1px solid blueviolet;
                border-collapse: collapse;
                position: absolute;
                width:100%;
            }
            tr{
                height: 20px;   
            }
            td{
                border:1px solid  blueviolet;
            }
        </style>
        <script>
            var array = avalon.range(0, 47)
          
            var startIndex = 0
            var endIndex = 10
            var vmodel = avalon.define("grid", function(vm) {
                vm.data = array
                vm.top = 0
                vm.$skipArray = "data"
                vm._data = array.slice(startIndex, endIndex)
            })


            avalon.ready(function() {
                var wrapper = document.getElementById("wrapper")
                var table = document.getElementById("table")

                //   console.log(vmodel.data[98])//23
                wrapper.style.height = trHeight * (vmodel.data.length + 100) + "px"
                var tableHeight = table.offsetHeight
                var trHeight = Math.ceil(tableHeight / vmodel._data.size())
             

                var prevScrollTop = 0
                var lastRenderedScrollTop = 0
                avalon.bind(wrapper, "scroll", function(e) {
                    var scrollTop = wrapper.scrollTop
                    var scrollDir = scrollTop > prevScrollTop ? "down" : "up"
                    prevScrollTop = scrollTop

                    if (Math.abs(lastRenderedScrollTop - scrollTop) >= trHeight) {
                        //     console.log(Math.abs(lastRenderedScrollTop - scrollTop) + "!!!!!!!!!")
                        if (scrollDir === "down") {
                            //console.log("11111111111111")
                            if (endIndex + 1 <= vmodel.data.length) {
                                vmodel._data.shift()
                                startIndex++
                                endIndex++
                                //  console.log(endIndex)
                                vmodel._data.push(vmodel.data[endIndex])
                            }
                        } else {
                            //  console.log(startIndex)
                            if (startIndex - 1 >= 0) {
                                startIndex--
                                endIndex--
                                vmodel._data.pop()
                                vmodel._data.unshift(vmodel.data[startIndex])

                            }
                        }
                        lastRenderedScrollTop = wrapper.scrollTop = startIndex * trHeight
                        vmodel.top = startIndex * trHeight
                    }


                })


            })
        </script>

    </head>
    <body>
        <div ms-controller="grid">
            <div class="wrapper" id="wrapper">
                <div style="position: relative;height: 2378px">
                    <table ms-css-top="top" id="table">
                        <tbody>
                            <tr ms-repeat="_data"><td>表格1</td><td>第{{el}}行</td><td>表格3</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </body> 
</html>