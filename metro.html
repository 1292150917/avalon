
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="avalon.js" type="text/javascript"></script>
        <script src="jquery.js" type="text/javascript"></script>
        <link href="metro.css" media="all" rel="stylesheet" type="text/css" />

        <script>

            //  var point = document.getElementById("redpoint")
            // if (point) {
            //      document.body.removeChild(point)
            //   }
            //   point = document.createElement("div")
            //    point.id = "redpoint"
            //   point.style.cssText = "position:absolute;z-index:1000;width:10px;height:10px;background:red;top:" + data.top + "px;left:" + data.left + "px;"
            //   document.body.appendChild(point)
            avalon.require("avalon.draggable", function() {
                function isNext(A, B) {//判定A是否在B的前面
                    var next = A.nextElementSibling
                    while (next !== null) {
                        if (next === B) {
                            return true
                        } else {
                            next = next.nextElementSibling
                        }
                    }
                }
                function getTarget(data, x, y) {
                    var target = document.elementFromPoint(data.pageX + x, data.pageY + y)
                    while (target && target.tagName != "APP") {
                        target = target.parentNode;
                    }
                    return target
                }
                function getTarget2(x, y) {
                    var target = document.elementFromPoint(x, y)
                    while (target && target.tagName != "APP") {
                        target = target.parentNode;
                    }
                    return target
                }
                function getSize(target) {
                    return target.className.match(/app_(\w+)/)[1]
                }
                function isApp(target) {
                    return target.tagName.toLowerCase() === "app"
                }
                function resetLayout(parent) {
                    var array = avalon.slice(parent.children)
                    var height = 0, column = 0, changeRow = true
                    for (var i = 0, el; el = array[i++]; ) {
                        var size = getSize(el)
                        //    avalon.log(size)
                        if (size === "small") {
                            height += 170
                            el.left = true
                            el.classList.add("noPaddingRight")
                            var next = array[i]
                            if (next && getSize(next) === "small") {
                                next.left = false
                                next.classList.remove("noPaddingRight")
                                //   avalon.log("small siblings")
                                i++
                            } else {
                                
                                el.insertAdjacentHTML("afterEnd","<app class='placehoder noPaddingRight app_small '>placehoder</app>")
                            }
                        } else if (size === "middle") {
                            height += 170
                            el.left = false
                        } else if (size === "big") {
                            height += 340
                            el.left = false
                            if (height >= 510) {
                                column++
                                //    avalon.log(height + "==============big")
                                if (height > 510) {
                                      el.insertAdjacentHTML("beforeBegin","<app class='placehoder app_middle '>placehoder</app>")
                                    //  avalon.log("另起一行")
                                    height = 340
                                } else {
                                    //    avalon.log(" 归零")
                                    height = 0
                                }
                            }

                        }
                        if (height >= 510) {
                            //  avalon.log(height + "============累加")
                            height = 0
                            column++
                        }
                    }
                    if (height > 0) {
                        column++
                    }
                    //  avalon.log("当前列数为 " + column)
                    parent.style.width = (column) * 360 + "px"
                }
                var parent = document.querySelector(".columns");
                var bodyPadding = parseFloat(avalon(document.body).css("margin-left"))
                var lastTime

                function swipeDirection(x1, x2, y1, y2) {
                    return Math.abs(x1 - x2) >=
                            Math.abs(y1 - y2) ? (x1 - x2 > 0 ? 'left' : 'right') : (y1 - y2 > 0 ? 'up' : 'down')
                }


                var model = avalon.define("xxx", function(vm) {
                    vm.array = ["middle", "small", "small", "small", "small", "small", "small", "big", "small", "small", "big", "big", "middle", "small", "small"]

                    vm.getColor = function() {
                        var letters = 'A523456789ABCDEF'.split('');
                        var color = '#';
                        for (var i = 0; i < 6; i++) {
                            color += letters[Math.round(Math.random() * 15)];
                        }
                        return color;
                    }
                    vm.current = ""
                    vm.handle = function(e) {
                        var el = e.target
                        if (/app_head/.test(el.className)) {
                            return el
                        }
                    }
                    vm.$map = []

                    vm.stop = avalon.noop
                    vm.start = function(e, data) {
                        model.$map = []
                        Array.prototype.forEach.call(document.querySelectorAll(".columns app"), function(node) {
                            if (node !== data.element) {
                                var $elem = avalon(node)
                                var offset = $elem.offset()
                                model.$map.push({
                                    top: offset.top,
                                    left: offset.left,
                                    right: offset.left + $elem.width(),
                                    bottom: offset.top + $elem.height(),
                                    node: node
                                })
                            }
                        })
                    }
                    vm.drag = function(e) {
                        var mouseX = e.pageX, mouseY = e.pageY
                        if (!lastTime || Date.now() - lastTime > 30) {
                            lastTime = Date.now()
                            for (var i = 0, obj; obj = model.$map[i++]; ) {
                                if (mouseX > obj.left && mouseX < obj.right && mouseY > obj.top && mouseY < obj.bottom) {
                                    var node = obj.node
                                    var old = document.querySelector(".moveTo")
                                    if (old != node) {
                                        old && old.classList.remove("moveTo")
                                        node.classList.add("moveTo")
                                        model.current = node.className
                                    }
                                }
                            }
                        }

                    }
                    vm.beforeStop = function(e, data) {
                        data.dragX = false
                        data.dragY = false

                        vm.$map = []
                        var el = data.$element
                        var width = el.width()
                        var height = el.height()
                        if (width > 150) {
                            width /= 2
                        }
                        if (height > 150) {
                            height /= 2
                        }
                        var dir = swipeDirection(data.startPageX, data.pageX, data.startPageY, data.pageY)

                        setTimeout(function() {

                            var el = document.querySelector(".moveTo")

                            if (el) {
                                if (dir == "left" || dir == "up") {
                                    el.parentNode.insertBefore(data.element, el || null)
                                    //    p = "后面"
                                } else {
                                    //     p = "前面"
                                    el.parentNode.insertBefore(data.element, el.nextElementSibling || null)
                                }
                                el.classList.remove("moveTo")

                                //    document.querySelectorAll(".moveTo")[0].classList.remove(".moveTo")
                            } else {//如果找不到说明用户把它放于一个空白处
                                //判定用户放置时的位置是靠当前列的左边还是右边
                                //     var isLeft = (data.pageX - bodyPadding) % 360 < 150
                                // var target = getTarget((data.pageX - bodyPadding) % 360 * 150, (data.pageY - bodyPadding) % 360 * 150)
                                //  alert(target && target.className)

                            }
                            Array.prototype.forEach.call(document.querySelectorAll("app.placehoder"), function(node) {
                                node.parentNode.removeChild(node)
                            })
                            //判定用户放置时的位置是靠当前列的左边还是右边
                            /*    var isLeft= (data.pageX - bodyPadding) % 360 < 150
                             
                             var target = getTarget(data, 10, 10)
                             var msg = "在其左上角找到，"
                             var swap = false
                             if (!target || !isApp(target)) {
                             target = getTarget(data, -150, 0)
                             if (target && target.left) {
                             target.parentNode.insertBefore(data.element, target.nextElementSibling)
                             swap = true
                             avalon.log("在左边找到，插入到" + target.className + "后面")
                             } else {
                             target = null
                             }
                             
                             }
                             if (isLeft) {
                             if (!target || !isApp(target)) {
                             target = getTarget(data, 150, -150)
                             if (target) {
                             target.parentNode.insertBefore(data.element, target.nextElementSibling)
                             swap = true
                             avalon.log("在右上边找到，插入到" + target.className + "后面")
                             }
                             }
                             }
                             if (!isLeft) {
                             if (!target || !isApp(target)) {
                             target = getTarget(data, -150, -150)
                             if (target) {
                             target.parentNode.insertBefore(data.element, target.nextElementSibling)
                             swap = true
                             avalon.log("在左上边找到，插入到" + target.className + "后面")
                             }
                             }
                             }
                             if (!target || !isApp(target)) {
                             target = getTarget(data, 0, -150)
                             if (target) {
                             target.parentNode.insertBefore(data.element, target.nextElementSibling)
                             swap = true
                             avalon.log("在正上边找到，插入到" + target.className + "后面")
                             }
                             }
                             console.log(target)
                             if (target && isApp(target)) {
                             if (!swap) {
                             var p = ""
                             if (isNext(data.element, target)) {
                             p = "后面"
                             target.parentNode.insertBefore(data.element, target.nextElementSibling)
                             } else {
                             p = "前面"
                             target.parentNode.insertBefore(data.element, target)
                             }
                             console.log("=================")
                             avalon.log(msg + "插入到" + target.className + p)
                             }
                             }*/
                            avalon(data.element).css("display", "inline-block").css("position", "static")
                            resetLayout(parent)
                        }, 300)
                    }

                })
                avalon.scan()

                setTimeout(function() {
                    resetLayout(parent)
                }, 200)
            })

        </script>
    </head>
    <body ms-controller="xxx">
        <p>{{current}}</p>
        <div class="columns"  ms-each-el="array">
            <app  ms-draggable="stop" data-start="start" data-drag="drag"  ms-attr-appindex="$index" data-before-stop="beforeStop" data-ghosting="true" data-handle="handle" ms-class="app_{{el}}" ms-class-="app{{$index}}">
                <div class="appme" ms-css-background="getColor()">
                    <div class="app_head">APP {{$index}}</div>
                </div>
            </app>
        </div>
    </body>
</html>
