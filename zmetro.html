
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="avalon.js"></script>
        <script src="jquery.js"></script>
        <script>
            require("avalon.draggable", function() {
                var check = false, swap = false, animate = false


                function enter(dropper, event) {

                    // 如果光标能进入矩形的内部
                    var left = dropper.left + dropper.height * 0.1 / 2
                    var top = dropper.top + dropper.height * 0.1 / 2
                    var right = dropper.left + dropper.width - dropper.height * 0.1 / 2
                    var bottom = dropper.top + dropper.height - dropper.height * 0.1 / 2
                    if (check) {
                        //   console.log([event.pageX, event.pageY, left, right, top, bottom])
                    }
                    if (event.pageX > left && event.pageX < right && event.pageY > top && event.pageY < bottom) {
                        return dropper
                    }

                }

                function swapDropAndDrag(drag, drop, dir) {

                    drop.top = drag._top || drag.top
                    drop.left = drag._left || drag.left

                    drag._top = swap.top
                    drag._left = swap.left
                    animate = drop.animate = false
                }
                var model = avalon.define("apps", function(vm) {
                    vm.getColor = function() {
                        var letters = 'A523456789ABCDEF'.split('');
                        var color = '#';
                        for (var i = 0; i < 6; i++) {
                            color += letters[Math.round(Math.random() * 15)];
                        }
                        return color;
                    }
                    vm.onLayout = function() {
                        var coffset = $(this).offset()
                        var children = this.children
                        var maxRow = 3//每一列最多 多少行，用于配置
                        var row = 0 //当前APP所在的栏数
                        var col = 0 //当前APP所在的栏数
                        var left = 1
                        for (var i = 0, el; el = model.apps[i]; i++) {
                            if (el.type == "small") {
                                if (left) {
                                    el.top = 130 * row + coffset.top
                                    el.left = col * 260 + left + coffset.left
                                    left = 0
                                    el.sleft = 1
                                } else {
                                    el.top = 130 * row + coffset.top
                                    el.left = col * 260 + 130 + coffset.left
                                    row++
                                    left = 1
                                    el.sleft = 0
                                }
                                el.width = 120
                                el.height = 120

                                if (row > maxRow) {
                                    row = 0
                                    col++
                                }
                            } else if (el.type == "middle") {
                                el.sleft = 1
                                if (!left) {
                                    row++
                                }
                                el.width = 250
                                el.height = 120
                                el.top = 130 * row + coffset.top
                                el.left = col * 260 + left + coffset.left
                                row++
                                left = 1
                                if (row > maxRow) {
                                    row = 0
                                    col++
                                }
                            } else if (el.type == "big") {
                                el.sleft = 1
                                if (!left) {
                                    row++
                                }
                                el.width = 250
                                el.height = 250
                                if (row + 1 > maxRow) {
                                    row = 0
                                    col++
                                }
                                el.top = 130 * row + coffset.left
                                el.left = col * 260 + left + coffset.left
                                row += 2
                                left = 1
                                if (row >= maxRow) {
                                    row = 0
                                    col++
                                }
                            }
                            el.index = i
                            el.element = children[i]
                            el.animate = false
                        }
                    }
                    function fix(array) {
                        for (var i = 0, el; el = array[i++]; ) {
                            el.top = 0
                            el.left = 0
                            el.width = 0
                            el.height = 0
                            el.sleft = 1
                            el.next = {}
                            el.prev = {}

                            el.element = {}
                            el.$skipArray = ["width", "height", "sleft", "animate", "element", "next", "prev"]

                        }
                        return array
                    }

                    vm.apps = fix([
                        {
                            text: "0",
                            type: "small"
                        },
                        {
                            text: "1",
                            type: "small"
                        },
                        {
                            text: "2",
                            type: "small"
                        },
                        {
                            text: "3",
                            type: "small"
                        },
                        {
                            text: "yyy",
                            type: "middle"
                        }
                        /*    {
                         text: "666",
                         type: "big"
                         },
                         {
                         text: "666",
                         type: "big"
                         },
                         {
                         text: "yyy",
                         type: "middle"
                         },
                         {
                         text: "3",
                         type: "small"
                         },
                         {
                         text: "4",
                         type: "small"
                         },
                         {
                         text: "yyyy",
                         type: "middle"
                         },
                         {
                         text: "yyyy",
                         type: "middle"
                         },
                         {
                         text: "yyyy",
                         type: "middle"
                         },
                         {
                         text: "yyyy",
                         type: "middle"
                         },
                         {
                         text: "5",
                         type: "small"
                         },
                         {
                         text: "6",
                         type: "small"
                         },
                         {
                         text: "7",
                         type: "small"
                         },
                         {
                         text: "8",
                         type: "small"
                         },
                         {
                         text: "9",
                         type: "small"
                         },
                         {
                         text: "10",
                         type: "small"
                         }*/
                    ])
                    vm.dragClass = ""
                    vm.start = function(e, data) {
                        avalon(this).addClass("current")
                        this.style.zIndex = 100
                        data._startPageX = data.pageX
                        data._startPageY = data.pageY
                        model.dragClass = "dragging"

                        if (check) {
                            console.log(model.apps)
                        }
                    }
                    vm.beforeStop = function(event) {
                        vm.dragClass = ""
                        this.style.zIndex = 0
                        check = true
                        avalon(this).removeClass("current")
                    }
                    vm.stop = function(event) {
                        var drag = this["data-vm"]
                        drag.animate = false
                        if (swap) {
                            var dir = swap.dir
                            $(this).animate((dir === "left" || dir == "right" ?
                                    {left: swap.left} : {top: swap.top}), 300, function() {

                                this.style.top = swap.top + "px"
                                this.style.left = swap.left + "px"
                                drag.top = swap.top
                                drag.left = swap.left
                                delete drag._top
                                delete drag._left
                                swap = false
                            })
                        } else {
                            this.style.top = drag.top + "px"
                            this.style.left = drag.left + "px"
                            delete drag._top
                            delete drag._left
                            swap = false
                        }
                    }
                    vm.drag = function(event) {
                        var drag = this["data-vm"]
                        drag.animate = true
           
                        if (animate)
                            return
                        var drop = false
                        for (var i = 0, el; el = model.apps[i]; i++) {
                            if (!el.animate && enter(el, event)) {
                                drop = el
                                break
                            }
                        }
                        if (drop) {
                            //求出是左移右移上移下移
                            var dir = ""
                            if (drop.top === drag.top) {//水平
                                dir = drop.left > drag.left ? "right" : "left"
                            } else {
                                dir = drop.top > drag.top ? "down" : "up"
                            }
                            console.log(dir)
                            if (drop.animate) {
                                return
                            }
                            drop.animate = animate = true
                            var dropIndex = model.apps.indexOf(drop)
                            var dragIndex = model.apps.indexOf(drag)
                            var next = model.apps[dropIndex + 1]
                            var interval = Math.abs(dropIndex - dragIndex)

                            //  avalon.Array._splice(model.apps, drag)
                            model.apps._splice(dragIndex, 1)
                            model.apps._splice(dropIndex, 0, drag)
                            console.log([dropIndex, dragIndex])
//                            if (aa === 1 && drop.type == "small" && drag.type === "small") {
//                                console.log("开始动画")
//                                $(drop.element).animate(dir === "left" || dir == "right" ?
//                                        {left: (drag._left || drag.left)} :
//                                        {top: (drag._top | drag.top)},
//                                50, function() {
//                                    swapDropAndDrag(drag, drop, dir)
//                                })
//                            } else {
                            if (drop.type === "small") {
                                //如果两个都是小的，从下往上
                                if (drop.sleft === 1) {
                                    drop.animate = next.animate = true
                                    //它正上面的元素往右边移动
                                    swap = {
                                        top: drop.top,
                                        left: drop.left,
                                        dir: dir
                                    }
                                    var dragTop = drag._top || drag.top
                                    var dragLeft = drag._left || drag.left

                                    drop.element.style.zIndex = 10
                                    next.element.style.zIndex = 10

                                    console.log(model.apps.map(function(el) {
                                        return el.index
                                    }))
                               //    console.log(model.apps)
                        
                                    $(drop.element).css("z-index", 100).animate({left: swap.left + 130}, 310, function() {
                                        drop.left = drop.left + 130
                                        animate = drop.animate = false
                                        drop.element.style.zIndex = 0
                                        drag._top = swap.top
                                        drag._left = swap.left

                                    })

                                    //原来上方右边的元素复制一份，为了进行slideRight效果，需要动态插入一个overflow为hidden父节点
                                    var clone = $(next.element).clone()
                                    //      console.log([next.top, next.left])
                                    var wrapper = $("<div/>").css({
                                        top: next.top,
                                        left: next.left,
                                        width: next.width,
                                        height: next.height,
                                        overflow: "hidden",
                                        position: "absolute",
                                        border: "1px solid red",
                                        "z-index": 2
                                    }).insertBefore(next.element).append(clone)

                                    //动画完毕移除
                                    clone.animate({left: drop.left + drop.width}, 295, function() {
                                        wrapper.remove()
                                    })

                                    var wrapper2 = wrapper.clone().css({
                                        top: drag.top,
                                        left: drag.left,
                                        width: next.width,
                                        height: next.height
                                    }).insertBefore(next.element).append(next.element)

                                    $(next.element).css({
                                        top: 0,
                                        left: -120   //移动容器的左边，让它看不见，然后再slideLeft出来
                                    }).animate({left: 120}, 300, function() {
                                        $(next.element).insertBefore(wrapper2)
                                        wrapper2.remove()

                                        next.top = dragTop
                                        next.left = dragLeft
                                        next.animate = false
                                    })
                                }
                            }
                        }
                    }

                })
                avalon.scan()
            })

        </script>
        <style>
            .apps{
                position: relative;
                border:10px solid #01B4D2;
                height: 510px;
            }
            .apps.dragging app:not(.current){
                -webkit-transform:scale(.9);
                -moz-transform:scale(.9);
                transform:scale(.9);
            }
            app{
                display: inline-block;
                position: absolute;
                -webkit-transition:-webkit-transform .3s ease-in-out;
                -moz-transition:-moz-transform .3s ease-in-out;
                transition:transform .3s ease-in-out;
                z-index:1;
            }
            app.current{
                z-index:100;
                opacity: 0.5;
                transform:scale(1.1);
            }
            app.small{
                width:120px;
                height:120px;
            }
            app.big{
                width:250px;
                height:250px;
            }
            app.middle{
                width:250px;
                height:120px;
            }
        </style>
    </head>
    <body>
        <div class="apps" ms-controller="apps" id="metro" ms-class="{{dragClass}}"ms-each="apps" data-each-rendered="onLayout">
            <app ms-draggable="apps" data-drag-start="start" 
                 data-drag-drag="drag" data-drag-stop="stop" 
                 data-drag-before-stop="beforeStop" 
                 ms-class="{{el.type}}" 
                 ms-data-vm="el" 
                 ms-css-background="getColor()" 
                 ms-css-top="top" ms-css-left="left">
                {{el.text }}</app>
        </div> 
    </body>
</html>
