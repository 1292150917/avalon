
<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <script src="avalon.js"></script>
        <script src="jquery.js"></script>
        <script>
            require("avalon.draggable", function() {

                function overlap(dropper, dragger, intersects) {
                    // 求出两个方块的重叠面积是否超过50%
                    var size = Math.max(0, Math.min(dropper.bottom - dropper.height * 0.1 / 2, dragger.bottom)
                            - Math.max(dropper.top + dropper.height * 0.1 / 2, dragger.top)) * Math.max(0, Math.min(dropper.right - dropper.width * 0.1 / 2, dragger.right)
                            - Math.max(dropper.left - dropper.width * 0.1 / 2, dragger.left));
                    //     console.log("SIZE  " + size + "  "+dropper.width * dropper.height)
                    if (size && (size / (dropper.width * dropper.height) > 0.9)) {
                        //  console.log(size / (dropper.width * dropper.height))
                        intersects.push({
                            dropper: dropper,
                            size: size
                        })
                        return true
                    }
                }

                var model = avalon.define("apps", function(vm) {
                    vm.getColor = function() {
                        var letters = 'A523456789ABCDEF'.split('');
                        var color = '#';
                        for (var i = 0; i < 6; i++) {
                            color += letters[Math.round(Math.random() * 15)];
                        }
                        return color;
                    }
                    vm.onLayout = function() {
                        var children = this.children
                        // console.log(children)
                        var maxRow = 3//每一列最多 多少行，用于配置
                        var row = 0 //当前APP所在的栏数
                        var col = 0 //当前APP所在的栏数
                        var left = 1
                        for (var i = 0, el; el = vm.apps[i]; i++) {
                            if (el.type == "small") {
                                if (left) {
                                    el.top = 130 * row
                                    el.left = col * 260 + left
                                    left = 0
                                    el.sleft = 1
                                } else {
                                    el.top = 130 * row
                                    el.left = col * 260 + 130
                                    row++
                                    left = 1
                                    el.sleft = 0
                                }
                                el.width = 120
                                el.height = 120
                                el.size = 120 * 120 * 0.9
                                if (row > maxRow) {
                                    row = 0
                                    col++
                                }
                            } else if (el.type == "middle") {
                                el.sleft = 1
                                if (!left) {
                                    row++
                                }
                                el.width = 250
                                el.height = 120
                                el.size = 250 * 120 * 0.9
                                el.top = 130 * row
                                el.left = col * 260 + left
                                row++
                                left = 1
                                if (row > maxRow) {
                                    row = 0
                                    col++
                                }
                            } else if (el.type == "big") {
                                el.sleft = 1
                                if (!left) {
                                    row++
                                }
                                el.width = 250
                                el.height = 250
                                el.size = 250 * 250 * 0.9
                                if (row + 1 > maxRow) {
                                    row = 0
                                    col++
                                }
                                el.top = 130 * row
                                el.left = col * 260 + left
                                row += 2
                                left = 1
                                if (row >= maxRow) {
                                    row = 0
                                    col++
                                }
                            }
                            el.index = i
                            el.element = children[i]
                            el.right = el.left + el.width
                            el.bottom = el.top + el.height
                            el.animate = false
                        }
                    }
                    function fix(array) {
                        for (var i = 0, el; el = array[i++]; ) {
                            el.top = 0
                            el.left = 0
                            el.sleft = 1
                            el.width = 0
                            el.height = 0
                            el.top = 0
                            el.right = 0
                            el.element = {}
                            el.size = 0
                            el.$skipArray = ["width", "height", "sleft", "right", "bottom", "animate", "element"]

                        }
                        return array
                    }
                    vm.apps = fix([
                        {
                            text: "0",
                            type: "small"
                        },
                        {
                            text: "1",
                            type: "small"
                        },
                        {
                            text: "顶 big",
                            type: "small"
                        },
                        {
                            text: "2",
                            type: "small"
                        },
                        {
                            text: "yyy",
                            type: "middle"
                        },
                        {
                            text: "666",
                            type: "big"
                        },
                        {
                            text: "666",
                            type: "big"
                        },
                        {
                            text: "yyy",
                            type: "middle"
                        },
                        {
                            text: "3",
                            type: "small"
                        },
                        {
                            text: "4",
                            type: "small"
                        },
                        {
                            text: "yyyy",
                            type: "middle"
                        },
                        {
                            text: "yyyy",
                            type: "middle"
                        },
                        {
                            text: "yyyy",
                            type: "middle"
                        },
                        {
                            text: "yyyy",
                            type: "middle"
                        },
                        {
                            text: "5",
                            type: "small"
                        },
                        {
                            text: "6",
                            type: "small"
                        },
                        {
                            text: "7",
                            type: "small"
                        },
                        {
                            text: "8",
                            type: "small"
                        },
                        {
                            text: "9",
                            type: "small"
                        },
                        {
                            text: "10",
                            type: "small"
                        }
                    ])
                    vm.dragClass = ""
                    vm.start = function(e, data) {
                        avalon(this).addClass("current")
                        data._startPageX = data.pageX
                        data._startPageY = data.pageY
                        vm.dragClass = "dragging"

                        // console.log(this["data-vm"].animate)
                    }
                    vm.beforeStop = function(e, data) {
                        //    data.dragX = data.dragY = false
                        vm.dragClass = ""
                        avalon(this).removeClass("current")
                    }
                    vm.stop = function(e, data) {
                        var target = this["data-vm"]
                        for (var i = 0, el; el = model.apps[i]; i++) {
                            el.animate = false
                        }
                        if (swap) {
                            var dir = swap.dir
                            $(this).animate((dir === "left" || dir == "right" ?
                                    {left: swap.left} : {top: swap.top}), 300, function() {
                                this.style.top = swap.top + "px"
                                this.style.left = swap.left + "px"
                                //    console.log([swap.top,swap.left])
                                target.top = swap.top
                                target.left = swap.left
                                delete target._top
                                delete target._left
                                swap = false
                            })
                        } else {
                            this.style.top = target.top + "px"
                            this.style.left = target.left + "px"
                            delete target._top
                            delete target._left
                            swap = false
                        }
                    }
                    var swap, animate
                    vm.drag = function(e, data) {
                        var target = this["data-vm"]
                        target.animate = true
                        if (animate)
                            return
                        var dragger = {
                            top: data.top,
                            left: data.left,
                            right: data.left + target.width,
                            bottom: data.top + target.height,
                            width: target.width,
                            height: target.height
                        }

                        //因为我们拖动的块块最多可能与3个方块相交，其中两个是有效，我们再从它们最大的相交面积决定移动方向
                        var intersects = []
                        for (var i = 0, el; el = model.apps[i]; i++) {

                            if (el !== target) {
                                if (el.animate) {
                                    // console.log("22222222222")
                                    if (overlap(el, dragger, intersects) !== true) {
                                        //    setTimeout(function(){
                                        el.animate = false
                                        //    },20)
                                        console.log("解套了")
                                    }
                                } else {
                                    if (overlap(el, dragger, intersects) === true) {
                                        if (intersects.length == 2) {
                                            break
                                        }
                                    }
                                }
                            }
                        }
                        if (intersects.length) {
                            var obj = intersects[0].dropper
                            console.log(obj)
                            if (intersects.length === 2) {
                                obj = intersects[0].size > intersects[1].size ? obj : intersects[1].dropper
                            }
                            //求出是左移右移上移下移
                            var dir = ""
                            if (obj.top === target.top) {//水平
                                dir = obj.left > target.left ? "right" : "left"
                            } else {
                                dir = obj.top > target.top ? "down" : "up"
                            }
                            //求出是否移入目标的长或宽的0.45
                            var ok = false
                            var oldWidth = obj.width * 0.9
                            var oldWidthLess = obj.width * 0.1 / 2
                            var oldHeightLess = obj.height * 0.1 / 2
                            var targetWidthMore = obj.width * 0.05 / 2
                            var targetHeightMore = obj.height * 0.05 / 2
                            var ratio = 0.45
                            //    console.log(ratio)
                            switch (dir) {
                                case "right":
                                    ok = Math.abs(dragger.right + targetWidthMore - (obj.left + oldWidthLess)) / oldWidth > ratio
                                    break;
                                case "left":
                                    ok = Math.abs(dragger.left - targetWidthMore - (obj.right - oldWidthLess)) / oldWidth > ratio
                                    break;
                                case "down":
                                    ok = Math.abs(dragger.bottom + targetHeightMore - (obj.top + oldHeightLess)) / oldWidth > ratio
                                    break
                                case "up":
                                    ok = Math.abs(dragger.top - targetHeightMore - (obj.bottom - oldHeightLess)) / oldWidth > ratio
                                    break;
                            }

                            if (ok) {

                                if (obj.animate) {
                                    return
                                }
                                //     console.log("==========================")
                                obj.animate = animate = true
                                var left = typeof target._left === "number" ? target._left : target.left
                                var top = typeof target._top === "number" ? target._top : target.top
                                //  console.log("让它移动到 " + left)
                                console.log("开始动画")
                                $(obj.element).animate(dir === "left" || dir == "right" ? {left: left} : {top: top}, 50, function() {
                                    console.log("结束动画")
                                    //  old = obj
                                    obj.animate = animate = false
                                    var _index = target.index
                                    target.index = obj.index
                                    obj.index = _index



                                    swap = {
                                        top: obj.top,
                                        left: obj.left,
                                        dir: dir
                                    }
                                    obj.element.style.top = top + "px"
                                    obj.element.style.left = left + "px"
                                    target._top = obj.top
                                    target._left = obj.left
                                    obj.top = top
                                    obj.left = left
                                })
                            }

                        }


                    }
                })
                avalon.scan()
            })

        </script>
        <style>
            .apps{
                position: relative;
                border:10px solid #01B4D2;
                height: 510px;
            }
            .apps.dragging app:not(.current){
                -webkit-transform:scale(.9);
                -moz-transform:scale(.9);
                transform:scale(.9);
                /*                -webkit-transform-origin:0% 0%;
                                -moz-transform-origin:0% 0%;
                                transform-origin:0% 0%;*/
            }
            app{
                display: inline-block;
                position: absolute;
                -webkit-transition:-webkit-transform .3s ease-in-out;
                -moz-transition:-moz-transform .3s ease-in-out;
                transition:transform .3s ease-in-out;
                z-index:1;
            }
            app.current{
                z-index:100;
                opacity: 0.5;
                transform:scale(1.1);
            }
            app.small{
                width:120px;
                height:120px;
            }
            app.big{
                width:250px;
                height:250px;
            }
            app.middle{
                width:250px;
                height:120px;
            }
        </style>
    </head>
    <body>
        <div class="apps" ms-controller="apps" id="metro" ms-class="{{dragClass}}"ms-each="apps" data-each-rendered="onLayout">
            <app ms-draggable="apps" data-drag-start="start" 
                 data-drag-drag="drag" data-drag-stop="stop" 
                 data-drag-before-stop="beforeStop" 
                 ms-class="{{el.type}}" 
                 ms-data-vm="el" 
                 ms-css-background="getColor()" 
                 ms-css-top="top" ms-css-left="left">
                {{el.text }}</app>
        </div> 
    </body>
</html>
